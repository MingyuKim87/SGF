<div align="center">

# Safety-Guided Flow (SGF) : SD-v2 Memorization Task 

<p align="center">
  [<a href="https://openreview.net/forum?id=EA80Zib9UI"><strong>OpenReview</strong></a>]
  <!-- [<a href=""><strong>ArXiv</strong></a>] -->
  <!-- [<a href="#citation"><strong>BibTeX</strong></a>] -->
</p>

</div>

Official PyTorch implementation of **Safety-Guided Flow (SGF)**, as presented in our paper: \
\
**Safety-Guided Flow (SGF): A Unified Framework for Negative Guidance in Safe Generation (ICLR2026 Oral)** \
Mingyu Kim, Young-Heon Kim, and Mijung Park

---

## Update
- [x] **SGF implementation & configs** completed (SGF core + task configs).
- [x] **Inference & retrieval evaluation** code completed (end-to-end runnable pipeline).
- [ ] Memorized **SDv2.1** checkpoint release (Google Drive) — **coming soon**.

## Code Base

This repository is built on top of the code base from:

- **Diffusion Art or Digital Forgery? Investigating Data Replication in Diffusion Models (CVPR2023)**
- Repo: https://github.com/somepago/DCR

So, you should first complete the environment / setup required by **DCR**, and then apply the additional SGF-specific setup described below.

---

## Environment Setup

> Follow the original **DCR** repository instructions first (requirements, checkpoints, etc.).
> After that, install any additional dependencies required by SGF.

A typical setup looks like:

```bash
# (example) create env
conda create -n SGF python=3.10 -y
conda activate SGF

# install packages
pip install -r requirements.txt
```

### 1) Imagenette-320 dataset (required)

Download **Imagenette-320** from:
- Download: **[Google Drive link placeholder]**

Place it under the repository root so that the following structure exists:

```text
datasets/imagenette2-320
├── temp
├── train
├── val
├── classnames.txt
├── imagenette_prompts_class.json
├── imagenette_prompts_nolevel.json
└── noisy_imagenette.csv
```

### 2) Cached files (required)

Download caches from:
- Download: **[Google Drive link placeholder]**

Place it under the repository root so that the following structure exists:

```text
caches/sd/memorization
└── repellency_proj_ref.pt
```

### 3) Memorized SDv2.1 Checkpoint (required)
This project assumes you have a **memorized SDv2.1** checkpoint prepared via training.
We provide a downloadable checkpoint for convenience:

- Download: **[Google Drive link placeholder]**

After placing/extracting it, the expected structure is:

```text
results
└── imagenette_class_classlevel_nodup
    ├── checkpoint
    ├── generations
    └── imagenette_prompts_class.json
```

Notes:
-	`results/imagenette_class_classlevel_nodup/checkpoint/` should contain the trained checkpoint files.
-	`results/imagenette_class_classlevel_nodup/generations/` will be used to store generated images (or may already contain them if you download a full bundle).

### 4) Run SGF Inference

Below is the minimal inference command.

# Example
MODEL_PATH=`results/imagenette_class_classlevel_nodup`

```bash
python sgf_inference.py \
  --nb 9469 \
  --dataset imagenette \
  --modelpath "$MODEL_PATH" \
  --task_config configs_sgf/sgf_2.yaml
```

### 4) Metric: Retrieval Evaluation
After inference finishes, run the retrieval-based metric:

```bash
python diff_retrieval.py \
  --arch resnet50_disc \
  --similarity_metric dotproduct \
  --pt_style sscd \
  --dist-url 'tcp://localhost:10001' \
  --world-size 1 --rank 0 \
  --query_dir inferences/imagenette10_frozentext/imagenette_class_classlevel_nodup/20250918034029/classlevel \
  --val_dir datasets/imagenette2-320/train
```
Notes:
  - `--query_dir` must point to the folder that contains the images generated by sgf_inference.py.
  - In the example above,
`inferences/imagenette10_frozentext/imagenette_class_classlevel_nodup/20250918034029/classlevel`
is just an example path; replace it with your actual output directory.

## Citation

```bibtex
@inproceedings{
  kim2026safetyguided,
  title={Safety-Guided Flow (SGF): A Unified Framework for Negative Guidance in Safe Generation},
  author={Mingyu Kim and Young-Heon Kim and Mijung Park},
  booktitle={The Fourteenth International Conference on Learning Representations},
  year={2026},
  url={https://openreview.net/forum?id=EA80Zib9UI}
}
```